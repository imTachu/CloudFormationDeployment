{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "Template de CloudFormation que despliega Core Cartera sin ELB (Usa HAProxy).",
    "Parameters": {
        "EC2InstanceType": {
            "Description": "Tipo de instancia EC2",
            "Type": "String",
            "Default": "t2.small",
            "AllowedValues": [
                "t2.small",
                "m4.large",
                "m4.xlarge",
                "m4.2xlarge",
                "c4.large",
                "c4.xlarge",
                "c4.2xlarge",
                "c4.4xlarge",
                "c4.8xlarge",
                "r3.large",
                "r3.xlarge",
                "r3.2xlarge",
                "r3.4xlarge",
                "r3.8xlarge"
            ],
            "ConstraintDescription": "debe seleccionar un tipo de instancia EC2 valido."
        },
        "KeyName": {
            "Description": "El keypair que permitira acceso a las instancias EC2",
            "Type": "AWS::EC2::KeyPair::KeyName",
            "ConstraintDescription": "debe seleccionar un keypair que conozca."
        },
        "AMIId": {
            "Description": "El id de la AMI que se usara para crear la Launch Configuration y posteriormente, el ASG.",
            "Type": "AWS::EC2::Image::Id",
            "ConstraintDescription": "debe contener el id de una AMI existente."
        },
        "SNSTopicName": {
            "Description": "Nombre del topico de SNS para notificar eventos del ASG",
            "Type": "String",
            "Default": " arn:aws:sns:us-east-1:186121879828:AutoscalingEventOcurrs",
            "ConstraintDescription": "debe contener el nombre de un topico de SNS existente."
        }
    },
    "Conditions": {
        "Is-EC2-VPC": {
            "Fn::Or": [
                {
                    "Fn::Equals": [
                        {
                            "Ref": "AWS::Region"
                        },
                        "eu-central-1"
                    ]
                },
                {
                    "Fn::Equals": [
                        {
                            "Ref": "AWS::Region"
                        },
                        "cn-north-1"
                    ]
                }
            ]
        },
        "Is-EC2-Classic": {
            "Fn::Not": [
                {
                    "Condition": "Is-EC2-VPC"
                }
            ]
        }
    },
    "Mappings": {
        "Region2Examples": {
            "us-east-1": {
                "Examples": "https://s3.amazonaws.com/cloudformation-examples-us-east-1"
            },
            "us-west-2": {
                "Examples": "https://s3-us-west-2.amazonaws.com/cloudformation-examples-us-west-2"
            },
            "us-west-1": {
                "Examples": "https://s3-us-west-1.amazonaws.com/cloudformation-examples-us-west-1"
            },
            "eu-west-1": {
                "Examples": "https://s3-eu-west-1.amazonaws.com/cloudformation-examples-eu-west-1"
            },
            "eu-central-1": {
                "Examples": "https://s3-eu-central-1.amazonaws.com/cloudformation-examples-eu-central-1"
            },
            "ap-southeast-1": {
                "Examples": "https://s3-ap-southeast-1.amazonaws.com/cloudformation-examples-ap-southeast-1"
            },
            "ap-northeast-1": {
                "Examples": "https://s3-ap-northeast-1.amazonaws.com/cloudformation-examples-ap-northeast-1"
            },
            "ap-southeast-2": {
                "Examples": "https://s3-ap-southeast-2.amazonaws.com/cloudformation-examples-ap-southeast-2"
            },
            "sa-east-1": {
                "Examples": "https://s3-sa-east-1.amazonaws.com/cloudformation-examples-sa-east-1"
            },
            "cn-north-1": {
                "Examples": "https://s3.cn-north-1.amazonaws.com.cn/cloudformation-examples-cn-north-1"
            }
        },
        "AWSInstanceType2Arch": {
            "t1.micro": {
                "Arch": "PV64"
            },
            "t2.micro": {
                "Arch": "HVM64"
            },
            "t2.small": {
                "Arch": "HVM64"
            },
            "t2.medium": {
                "Arch": "HVM64"
            },
            "m1.small": {
                "Arch": "PV64"
            },
            "m1.medium": {
                "Arch": "PV64"
            },
            "m1.large": {
                "Arch": "PV64"
            },
            "m1.xlarge": {
                "Arch": "PV64"
            },
            "m2.xlarge": {
                "Arch": "PV64"
            },
            "m2.2xlarge": {
                "Arch": "PV64"
            },
            "m2.4xlarge": {
                "Arch": "PV64"
            },
            "m3.medium": {
                "Arch": "HVM64"
            },
            "m3.large": {
                "Arch": "HVM64"
            },
            "m3.xlarge": {
                "Arch": "HVM64"
            },
            "m3.2xlarge": {
                "Arch": "HVM64"
            },
            "c1.medium": {
                "Arch": "PV64"
            },
            "c1.xlarge": {
                "Arch": "PV64"
            },
            "c3.large": {
                "Arch": "HVM64"
            },
            "c3.xlarge": {
                "Arch": "HVM64"
            },
            "c3.2xlarge": {
                "Arch": "HVM64"
            },
            "c3.4xlarge": {
                "Arch": "HVM64"
            },
            "c3.8xlarge": {
                "Arch": "HVM64"
            },
            "c4.large": {
                "Arch": "HVM64"
            },
            "c4.xlarge": {
                "Arch": "HVM64"
            },
            "c4.2xlarge": {
                "Arch": "HVM64"
            },
            "c4.4xlarge": {
                "Arch": "HVM64"
            },
            "c4.8xlarge": {
                "Arch": "HVM64"
            },
            "g2.2xlarge": {
                "Arch": "HVMG2"
            },
            "r3.large": {
                "Arch": "HVM64"
            },
            "r3.xlarge": {
                "Arch": "HVM64"
            },
            "r3.2xlarge": {
                "Arch": "HVM64"
            },
            "r3.4xlarge": {
                "Arch": "HVM64"
            },
            "r3.8xlarge": {
                "Arch": "HVM64"
            },
            "i2.xlarge": {
                "Arch": "HVM64"
            },
            "i2.2xlarge": {
                "Arch": "HVM64"
            },
            "i2.4xlarge": {
                "Arch": "HVM64"
            },
            "i2.8xlarge": {
                "Arch": "HVM64"
            },
            "d2.xlarge": {
                "Arch": "HVM64"
            },
            "d2.2xlarge": {
                "Arch": "HVM64"
            },
            "d2.4xlarge": {
                "Arch": "HVM64"
            },
            "d2.8xlarge": {
                "Arch": "HVM64"
            },
            "hi1.4xlarge": {
                "Arch": "HVM64"
            },
            "hs1.8xlarge": {
                "Arch": "HVM64"
            },
            "cr1.8xlarge": {
                "Arch": "HVM64"
            },
            "cc2.8xlarge": {
                "Arch": "HVM64"
            }
        },
        "AWSInstanceType2NATArch": {
            "t1.micro": {
                "Arch": "NATPV64"
            },
            "t2.micro": {
                "Arch": "NATHVM64"
            },
            "t2.small": {
                "Arch": "NATHVM64"
            },
            "t2.medium": {
                "Arch": "NATHVM64"
            },
            "m1.small": {
                "Arch": "NATPV64"
            },
            "m1.medium": {
                "Arch": "NATPV64"
            },
            "m1.large": {
                "Arch": "NATPV64"
            },
            "m1.xlarge": {
                "Arch": "NATPV64"
            },
            "m2.xlarge": {
                "Arch": "NATPV64"
            },
            "m2.2xlarge": {
                "Arch": "NATPV64"
            },
            "m2.4xlarge": {
                "Arch": "NATPV64"
            },
            "m3.medium": {
                "Arch": "NATHVM64"
            },
            "m3.large": {
                "Arch": "NATHVM64"
            },
            "m3.xlarge": {
                "Arch": "NATHVM64"
            },
            "m3.2xlarge": {
                "Arch": "NATHVM64"
            },
            "c1.medium": {
                "Arch": "NATPV64"
            },
            "c1.xlarge": {
                "Arch": "NATPV64"
            },
            "c3.large": {
                "Arch": "NATHVM64"
            },
            "c3.xlarge": {
                "Arch": "NATHVM64"
            },
            "c3.2xlarge": {
                "Arch": "NATHVM64"
            },
            "c3.4xlarge": {
                "Arch": "NATHVM64"
            },
            "c3.8xlarge": {
                "Arch": "NATHVM64"
            },
            "c4.large": {
                "Arch": "NATHVM64"
            },
            "c4.xlarge": {
                "Arch": "NATHVM64"
            },
            "c4.2xlarge": {
                "Arch": "NATHVM64"
            },
            "c4.4xlarge": {
                "Arch": "NATHVM64"
            },
            "c4.8xlarge": {
                "Arch": "NATHVM64"
            },
            "g2.2xlarge": {
                "Arch": "NATHVMG2"
            },
            "r3.large": {
                "Arch": "NATHVM64"
            },
            "r3.xlarge": {
                "Arch": "NATHVM64"
            },
            "r3.2xlarge": {
                "Arch": "NATHVM64"
            },
            "r3.4xlarge": {
                "Arch": "NATHVM64"
            },
            "r3.8xlarge": {
                "Arch": "NATHVM64"
            },
            "i2.xlarge": {
                "Arch": "NATHVM64"
            },
            "i2.2xlarge": {
                "Arch": "NATHVM64"
            },
            "i2.4xlarge": {
                "Arch": "NATHVM64"
            },
            "i2.8xlarge": {
                "Arch": "NATHVM64"
            },
            "d2.xlarge": {
                "Arch": "NATHVM64"
            },
            "d2.2xlarge": {
                "Arch": "NATHVM64"
            },
            "d2.4xlarge": {
                "Arch": "NATHVM64"
            },
            "d2.8xlarge": {
                "Arch": "NATHVM64"
            },
            "hi1.4xlarge": {
                "Arch": "NATHVM64"
            },
            "hs1.8xlarge": {
                "Arch": "NATHVM64"
            },
            "cr1.8xlarge": {
                "Arch": "NATHVM64"
            },
            "cc2.8xlarge": {
                "Arch": "NATHVM64"
            }
        },
        "AWSRegionArch2AMI": {
            "us-east-1": {
                "PV64": "ami-5fb8c835",
                "HVM64": "ami-60b6c60a",
                "HVMG2": "ami-e998ea83"
            },
            "us-west-2": {
                "PV64": "ami-d93622b8",
                "HVM64": "ami-f0091d91",
                "HVMG2": "ami-315f4850"
            },
            "us-west-1": {
                "PV64": "ami-56ea8636",
                "HVM64": "ami-d5ea86b5",
                "HVMG2": "ami-943956f4"
            },
            "eu-west-1": {
                "PV64": "ami-95e33ce6",
                "HVM64": "ami-bff32ccc",
                "HVMG2": "ami-83fd23f0"
            },
            "eu-central-1": {
                "PV64": "ami-794a5915",
                "HVM64": "ami-bc5b48d0",
                "HVMG2": "ami-ba1a09d6"
            },
            "ap-northeast-1": {
                "PV64": "ami-393c1957",
                "HVM64": "ami-383c1956",
                "HVMG2": "ami-08e5c166"
            },
            "ap-southeast-1": {
                "PV64": "ami-34bd7a57",
                "HVM64": "ami-c9b572aa",
                "HVMG2": "ami-5a15d239"
            },
            "ap-southeast-2": {
                "PV64": "ami-ced887ad",
                "HVM64": "ami-48d38c2b",
                "HVMG2": "ami-0c1a446f"
            },
            "sa-east-1": {
                "PV64": "ami-7d15ad11",
                "HVM64": "ami-6817af04",
                "HVMG2": "NOT_SUPPORTED"
            },
            "cn-north-1": {
                "PV64": "ami-18ac6575",
                "HVM64": "ami-43a36a2e",
                "HVMG2": "NOT_SUPPORTED"
            }
        }
    },
    "Resources": {
        "WebServerGroup": {
            "Type": "AWS::AutoScaling::AutoScalingGroup",
            "Properties": {
                "AvailabilityZones": {
                    "Fn::GetAZs": ""
                },
                "LaunchConfigurationName": {
                    "Ref": "LaunchConfig"
                },
                "MinSize": "1",
                "MaxSize": "3",
                "NotificationConfigurations" : [
                    {
                        "TopicARN" : { "Ref" : "SNSTopicName" },
                        "NotificationTypes" : [
                            "autoscaling:EC2_INSTANCE_LAUNCH",
                            "autoscaling:EC2_INSTANCE_LAUNCH_ERROR",
                            "autoscaling:EC2_INSTANCE_TERMINATE",
                            "autoscaling:EC2_INSTANCE_TERMINATE_ERROR"
                        ]
                    }
                ]
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "4e3de26a-5fce-434f-b2fd-0f2d7e55db9d"
                }
            }
        },
        "LaunchConfig": {
            "Type": "AWS::AutoScaling::LaunchConfiguration",
            "Metadata": {
                "Comment": "Install Cartera",
                "AWS::CloudFormation::Designer": {
                    "id": "22356e39-a347-473f-b6fd-fae4b6b86598"
                }
            },
            "Properties": {
                "KeyName": {
                    "Ref": "KeyName"
                },
                "ImageId": {
                    "Ref": "AMIId"
                },
                "SecurityGroups": [
                    {
                        "Ref": "InstanceSecurityGroup"
                    }
                ],
                "InstanceType": {
                    "Ref": "EC2InstanceType"
                },
                "UserData": {
                    "Fn::Base64": {
                        "Fn::Join": [
                            "",
                            [
                                "#!/bin/bash -xe\n",
                                "yum update -y aws-cfn-bootstrap\n",
                                "/opt/aws/bin/cfn-init -v ",
                                "         --stack ",
                                {
                                    "Ref": "AWS::StackName"
                                },
                                "         --resource LaunchConfig ",
                                "         --region ",
                                {
                                    "Ref": "AWS::Region"
                                },
                                "\n",
                                "/opt/aws/bin/cfn-signal -e $? ",
                                "         --stack ",
                                {
                                    "Ref": "AWS::StackName"
                                },
                                "         --resource WebServerGroup ",
                                "         --region ",
                                {
                                    "Ref": "AWS::Region"
                                },
                                "\n"
                            ]
                        ]
                    }
                }
            }
        },
        "WebServerScaleUpPolicy": {
            "Type": "AWS::AutoScaling::ScalingPolicy",
            "Properties": {
                "AdjustmentType": "ChangeInCapacity",
                "AutoScalingGroupName": {
                    "Ref": "WebServerGroup"
                },
                "Cooldown": "120",
                "ScalingAdjustment": "1"
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "a0218ebf-4715-435e-92f0-b281d8ff0af6"
                }
            }
        },
        "CPUAlarmHigh": {
            "Type": "AWS::CloudWatch::Alarm",
            "Properties": {
                "AlarmDescription": "Scale-up if CPU > 60% for 5 minutes",
                "MetricName": "CPUUtilization",
                "Namespace": "AWS/EC2",
                "Statistic": "Average",
                "Period": "300",
                "EvaluationPeriods": "1",
                "Threshold": "60",
                "AlarmActions": [
                    {
                        "Ref": "WebServerScaleUpPolicy"
                    }
                ],
                "Dimensions": [
                    {
                        "Name": "AutoScalingGroupName",
                        "Value": {
                            "Ref": "WebServerGroup"
                        }
                    }
                ],
                "ComparisonOperator": "GreaterThanThreshold"
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "a2bbce4f-a6bf-4f19-818d-39616c26f8ed"
                }
            }
        },
        "InstanceSecurityGroup": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "GroupDescription": "Enable SSH access",
                "SecurityGroupIngress": [
                    {
                        "IpProtocol": "tcp",
                        "FromPort": "22",
                        "ToPort": "22",
                        "CidrIp": "0.0.0.0/0"
                    }
                ]
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "1d7549ae-d409-4ce7-a96c-2065c844a256"
                }
            }
        }
    },
    "Outputs": {
        "URL": {
            "Description": "The URL of the website",
            "Value": "tejt"
        }
    },
    "Metadata": {
        "AWS::CloudFormation::Designer": {
            "941a475f-d1fe-4fc0-b81f-9a0402e29b7d": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 330,
                    "y": 30
                },
                "z": 1,
                "embeds": []
            },
            "1d7549ae-d409-4ce7-a96c-2065c844a256": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 480,
                    "y": 30
                },
                "z": 1,
                "embeds": [],
                "isrelatedto": [
                    "941a475f-d1fe-4fc0-b81f-9a0402e29b7d"
                ]
            },
            "22356e39-a347-473f-b6fd-fae4b6b86598": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 480,
                    "y": 120
                },
                "z": 1,
                "embeds": [],
                "ismemberof": [
                    "1d7549ae-d409-4ce7-a96c-2065c844a256"
                ]
            },
            "4e3de26a-5fce-434f-b2fd-0f2d7e55db9d": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 330,
                    "y": 120
                },
                "z": 1,
                "embeds": [],
                "isconnectedto": [
                    "941a475f-d1fe-4fc0-b81f-9a0402e29b7d"
                ],
                "isassociatedwith": [
                    "22356e39-a347-473f-b6fd-fae4b6b86598"
                ],
                "isrelatedto": [
                    "1a4ce61a-88e0-4d8e-85a7-716246ab2265",
                    "c0ab621b-581c-4e28-a498-affd206561c1"
                ]
            },
            "012f304e-bf66-4bd2-8559-2bfb9c49b65f": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 330,
                    "y": 240
                },
                "z": 1,
                "embeds": [],
                "isassociatedwith": [
                    "4e3de26a-5fce-434f-b2fd-0f2d7e55db9d"
                ]
            },
            "c321f7d5-5ed5-47d7-826d-3815627c4df7": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 450,
                    "y": 240
                },
                "z": 1,
                "embeds": [],
                "isrelatedto": [
                    "012f304e-bf66-4bd2-8559-2bfb9c49b65f",
                    "4e3de26a-5fce-434f-b2fd-0f2d7e55db9d"
                ]
            },
            "a0218ebf-4715-435e-92f0-b281d8ff0af6": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 90,
                    "y": 60
                },
                "z": 1,
                "embeds": [],
                "isassociatedwith": [
                    "4e3de26a-5fce-434f-b2fd-0f2d7e55db9d"
                ]
            },
            "a2bbce4f-a6bf-4f19-818d-39616c26f8ed": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 90,
                    "y": 150
                },
                "z": 1,
                "embeds": [],
                "isrelatedto": [
                    "a0218ebf-4715-435e-92f0-b281d8ff0af6",
                    "4e3de26a-5fce-434f-b2fd-0f2d7e55db9d"
                ]
            },
            "fb1f400c-f4a0-4d0f-b1c0-c733793817b1": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 690,
                    "y": 210
                },
                "z": 1,
                "embeds": [],
                "isrelatedto": [
                    "1d7549ae-d409-4ce7-a96c-2065c844a256"
                ]
            },
            "265f9679-ab8e-46a8-9548-bbdfce7fe42b": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 570,
                    "y": 90
                },
                "z": 1,
                "embeds": [],
                "isrelatedto": [
                    "1d7549ae-d409-4ce7-a96c-2065c844a256"
                ]
            },
            "ac2fd194-dc80-4644-897b-6d0c3f0fb1ab": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 690,
                    "y": 90
                },
                "z": 1,
                "embeds": [],
                "ismemberof": [
                    "fb1f400c-f4a0-4d0f-b1c0-c733793817b1"
                ],
                "isrelatedto": [
                    "265f9679-ab8e-46a8-9548-bbdfce7fe42b"
                ]
            },
            "c0ab621b-581c-4e28-a498-affd206561c1": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 180,
                    "y": 90
                },
                "z": 1,
                "embeds": []
            }
        }
    }
}
